# äº§å“éœ€æ±‚æ–‡æ¡£ (PRD) - AI æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹ (Smart Travel Agent)

| é¡¹ç›® | å†…å®¹ |
| :--- | :--- |
| **æ–‡æ¡£ç‰ˆæœ¬** | V2.1 (Final Cost-Optimized) |
| **çŠ¶æ€** | å¾…å¼€å‘ |
| **æ ¸å¿ƒç­–ç•¥** | **All-in Gemini** (æ¨¡å‹+æœç´¢) + **OpenStreetMap** (å…è´¹åœ°å›¾) + **äº¤é€šè§„åˆ’** |

---

## 1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡ (Background & Goals)
æ‰“é€ ä¸€æ¬¾**é›¶è¾¹é™…æˆæœ¬**ã€**é«˜å¯ç”¨**çš„æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹ã€‚
åŒºåˆ«äº V1.0ï¼Œæœ¬ç‰ˆæœ¬ç§»é™¤äº†æ˜‚è´µçš„ Google Places APIï¼Œæ”¹ç”¨ OpenStreetMap ç”Ÿæ€ï¼›å¹¶å¼•å…¥äº†**äº¤é€šæ¥é©³é€»è¾‘**ï¼Œè§£å†³äº†â€œåªæœ‰æ™¯ç‚¹æ²¡æœ‰è·¯â€çš„é—®é¢˜ã€‚

**æ ¸å¿ƒä»·å€¼:**
1.  **æä½æˆæœ¬**: åˆ©ç”¨ Gemini èµ é‡‘ + å¼€æºåœ°å›¾æ•°æ®ï¼Œå°†å•æ¬¡ç”Ÿæˆæˆæœ¬é™è‡³æ¥è¿‘ $0ã€‚
2.  **è½åœ°æ€§å¼º**: å¢åŠ äº†äº¤é€šè§„åˆ’ï¼ˆæ‰“è½¦/æ­¥è¡Œï¼‰ï¼Œè®©è¡Œç¨‹å…·å¤‡å®æ“æ€§ã€‚
3.  **ä½“éªŒä¼˜åŒ–**: é‡‡ç”¨â€œæ–‡å­—æµå¼è¾“å‡º + åœ°å›¾å»¶è¿Ÿæ¸²æŸ“â€ç­–ç•¥ï¼Œè§£å†³ç­‰å¾…ç„¦è™‘ã€‚

---

## 2. ç”¨æˆ·äº¤äº’ä¸è¾“å…¥ (User Interaction)

### 2.1 è¡Œç¨‹é…ç½®é¢æ¿ (Config Panel)
å‰ç«¯å·¦ä¾§è¡¨å•éœ€åŒ…å«ä»¥ä¸‹æ ¸å¿ƒå­—æ®µï¼š
* **ç›®çš„åœ°**: (e.g., "Kyoto")
* **æ—¥æœŸèŒƒå›´**: (Date Picker)
* **æ—…è¡ŒèŠ‚å¥**: (ç‰¹ç§å…µ / ä¼‘é—²)
* **[æ–°å¢] äº¤é€šåå¥½ (Transport Mode)**:
    * ğŸš— **æ•ˆç‡ä¼˜å…ˆ (Taxi/Uber)**: ä¼˜å…ˆæ‰“è½¦ï¼Œå°‘èµ°è·¯ã€‚
    * ğŸšŒ **å…¬å…±äº¤é€š (Public Transit)**: åœ°é“/å·´å£«ä¸ºä¸»ã€‚
    * ğŸš¶ **City Walk**: 2km å†…å¼ºåˆ¶æ­¥è¡Œï¼Œæ„Ÿå—åŸå¸‚ã€‚
* **é¢„ç®—**: (ç©·æ¸¸ / å¥¢å)

### 2.2 äº¤äº’æµç¨‹ (The "UI Cheat" Flow)
1.  **ç”¨æˆ·æäº¤**: ç‚¹å‡»ç”Ÿæˆã€‚
2.  **æ–‡å­—å…ˆè¡Œ**: èŠå¤©æ¡†ç«‹å³å¼€å§‹æ‰“å­—æœºè¾“å‡ºï¼šâ€œå¥½çš„ï¼Œæ ¹æ®æ‚¨çš„ City Walk åå¥½ï¼Œç¬¬ä¸€ç«™æˆ‘ä»¬å»...â€
3.  **åå°è®¡ç®—**: åç«¯åœ¨ç”Ÿæˆæ–‡å­—çš„åŒæ—¶ï¼Œå¼‚æ­¥è§£æç»çº¬åº¦å¹¶è®¡ç®—äº¤é€šæ—¶é—´ã€‚
4.  **åœ°å›¾è·Ÿè¿›**: å½“æŸä¸€æ®µè¡Œç¨‹è§£æå®Œæ¯•ï¼Œå³ä¾§åœ°å›¾è‡ªåŠ¨å¼¹å‡º Marker å’Œè¿çº¿ã€‚

---

## 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Core Logic)

### 3.1 æ™ºèƒ½ç”Ÿæˆä¸äº¤é€šæ’å…¥ (LLM & Transport)
* **æ¨¡å‹**: Google Gemini 1.5 Flash (å¼€å¯ JSON Mode)ã€‚
* **Prompt é€»è¾‘**:
    * å¿…é¡»æ ¹æ®ç”¨æˆ·çš„ `Transport Mode`ï¼Œåœ¨ä¸¤ä¸ªæ™¯ç‚¹ä¹‹é—´æ’å…¥ `Transport Node`ã€‚
    * *Example*: å¦‚æœç”¨æˆ·é€‰â€œæ­¥è¡Œâ€ï¼Œä¸”ä¸¤ç‚¹è·ç¦» 800ç±³ï¼ŒLLM è¾“å‡ºï¼šâ€œæ­¥è¡Œ 10 åˆ†é’Ÿâ€ã€‚
    * *Example*: å¦‚æœç”¨æˆ·é€‰â€œæ‰“è½¦â€ï¼Œä¸”è·ç¦» 5å…¬é‡Œï¼ŒLLM è¾“å‡ºï¼šâ€œæ‰“è½¦ 15 åˆ†é’Ÿâ€ã€‚

### 3.2 é›¶æˆæœ¬åæ ‡æœåŠ¡ (Coordinate Service)
* **æ›¿ä»£æ–¹æ¡ˆ**: ç§»é™¤ `Google Places API`ã€‚
* **æ–°æµç¨‹**:
    1.  æ‹¿åˆ°åœ°ç‚¹å (e.g., "Kiyomizu-dera")ã€‚
    2.  æŸ¥æœ¬åœ°ç¼“å­˜ (Redis/SQLite)ã€‚
    3.  æœªå‘½ä¸­ -> è°ƒ **Nominatim API (OpenStreetMap)** è·å– `lat/lon`ã€‚
    4.  **å›¾ç‰‡å¤„ç†**: æ”¾å¼ƒè°ƒç”¨æ˜‚è´µçš„ Google Photo APIï¼Œæ”¹ç”¨ **Emoji** (â›©ï¸) æˆ– **Unsplash å…è´¹å›¾åº“**ã€‚

---

## 4. æ•°æ®ç»“æ„å®šä¹‰ (Data Schema)

åç«¯ `/chat` æ¥å£è¿”å›çš„æ ‡å‡† JSONã€‚æ³¨æ„ `route_segments` é‡Œçš„å¤šæ€ç»“æ„ã€‚

```json
{
  "trip_title": "äº¬éƒ½å¤éŸµä¸€æ—¥æ¸¸",
  "summary": "ä¸“ä¸º City Walk è®¾è®¡çš„è·¯çº¿ï¼Œå…¨é•¿æ­¥è¡Œçº¦ 3 å…¬é‡Œ...",
  "days": [
    {
      "day_index": 1,
      "date": "2026-03-10",
      "route_segments": [
        {
          "type": "place",  // å®ä½“åœ°ç‚¹
          "name": "æ¸…æ°´å¯º",
          "description": "äº¬éƒ½æœ€è‘—åçš„å¤åˆ¹ï¼Œæ‚¬ç©ºçš„æ¸…æ°´èˆå°...",
          "emoji": "â›©ï¸",
          "coordinates": [34.9949, 135.7850] // æ¥è‡ª Nominatim
        },
        {
          "type": "transport", // [æ–°å¢] äº¤é€šæ¥é©³æ®µ
          "mode": "walk",      // æ­¥è¡Œ/subway/taxi
          "duration": "15 min",
          "instruction": "æ²¿ä¸‰å¹´å‚å‘ä¸‹æ­¥è¡Œï¼Œæ²¿é€”æœ‰è®¸å¤šæ‰‹ä¿¡åº—"
        },
        {
          "type": "place",
          "name": "å…«å‚ç¥ç¤¾",
          "description": "ç¥—å›­çš„å®ˆæŠ¤ç¥ç¤¾...",
          "emoji": "ğŸ®",
          "coordinates": [35.0037, 135.7785]
        }
      ]
    }
  ]
}
```

---

## 5. æŠ€æœ¯æ¶æ„æ ˆ (Tech Stack)

### 5.1 åç«¯ (Backend)
* **Framework**: Python FastAPI
* **LLM**: `langchain_google_genai` (Gemini 1.5 Flash)
* **Maps Service**: `OSMnx` æˆ– `requests` è°ƒç”¨ Nominatim API
* **Cache**: ç®€å•çš„å†…å­˜å­—å…¸ (MVP) æˆ– Redis (Production)

### 5.2 å‰ç«¯ (Frontend)
* **Framework**: React + Vite
* **Map Component**: `react-leaflet` (å®Œå…¨å…è´¹)
* **Map Tiles**: OpenStreetMap Standard Tiles
* **State Management**: React `useState` / Context API

---

## 6. å¼€å‘é‡Œç¨‹ç¢‘ (Milestones)

### Phase 1: é™æœ¬å¢æ•ˆåŸºå»º (1-2 å¤©)
- [ ] ç”³è¯·å¹¶é…ç½® Gemini API Keyã€‚
- [ ] ç¼–å†™ `osm_service.py`ï¼šå®ç°åœ°ç‚¹åè½¬åæ ‡çš„å‡½æ•°ï¼Œå¹¶åŠ ä¸Šç®€å•çš„ç¼“å­˜æœºåˆ¶ã€‚
- [ ] éªŒè¯ Nominatim API çš„è°ƒç”¨é¢‘ç‡ï¼Œç¡®ä¿ä¸è¢«å° IPã€‚

### Phase 2: æ ¸å¿ƒ Prompt å‡çº§ (2 å¤©)
- [ ] ä¿®æ”¹ System Promptï¼Œæ•™ä¼š Gemini è¾“å‡º `place` å’Œ `transport` æ··åˆçš„ JSON åˆ—è¡¨ã€‚
- [ ] è°ƒè¯• Promptï¼Œç¡®ä¿äº¤é€šæ—¶é—´çš„ä¼°ç®—ï¼ˆå¦‚â€œæ­¥è¡Œ10åˆ†é’Ÿâ€ï¼‰åŸºæœ¬ç¬¦åˆå¸¸è¯†ã€‚

### Phase 3: å‰ç«¯åœ°å›¾é‡æ„ (3 å¤©)
- [ ] å¸è½½ Google Maps SDKã€‚
- [ ] å¼•å…¥ `react-leaflet`ã€‚
- [ ] å®ç°â€œè¿çº¿é€»è¾‘â€ï¼šå°† JSON ä¸­çš„åæ ‡ç‚¹ç”¨ `Polyline` ä¸²è”èµ·æ¥ã€‚
- [ ] å®ç°â€œè‡ªå®šä¹‰ Iconâ€ï¼šç”¨ Emoji ä½œä¸ºåœ°å›¾ä¸Šçš„ Marker å›¾æ ‡ã€‚

---

## 7. é£é™©æ§åˆ¶ (Risk Management)

| é£é™©ç‚¹ | è§£å†³æ–¹æ¡ˆ |
| :--- | :--- |
| **Nominatim æœä¸åˆ°ååƒ»åœ°ç‚¹** | å‰ç«¯åšå®¹é”™ï¼šå¦‚æœæ²¡æœ‰åæ ‡ï¼Œåœ°å›¾ä¸Šä¸æ˜¾ç¤ºè¯¥ç‚¹ï¼Œä½†å·¦ä¾§æ–‡å­—åˆ—è¡¨ä¾ç„¶ä¿ç•™ã€‚ |
| **å…è´¹åœ°å›¾ç“¦ç‰‡åŠ è½½æ…¢** | ä½¿ç”¨å›½å†…çš„é•œåƒæº (å¦‚ CartoDB) æˆ–é¢„åŠ è½½æŠ€æœ¯ã€‚ |
| **LLM è¾“å‡º JSON æ ¼å¼é”™è¯¯** | Gemini çš„ `response_mime_type="application/json"` éå¸¸ç¨³å®šï¼Œé…åˆ Pydantic è§£ææ ¡éªŒã€‚ |
